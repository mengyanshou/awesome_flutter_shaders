#include <../common/common_header.frag>
// superResolution - Buf C
//
// Conv 2 - 2x2x12
//
// Image Super-Resolution Using Deep Convolutional Networks.
// Shadertoy implementation of SRCNN described in https://arxiv.org/pdf/1501.00092.pdf
//
// Created by Dmitry Andreev - and'2017
// License Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License.

vec4 fetch(const vec2 stc, const int ch, const int y, const int x)
{
    vec2 local_size = floor(iResolution.xy / vec2(3, 1));
    vec2 local_stc = stc - local_size * floor(stc / local_size);

    vec2 ch_size = floor(iResolution.xy / vec2(3, 2));
    vec2 ch_stc;

    ch_stc.x = (float(ch / 4) - 3.0 * floor(float(ch / 4) / 3.0)) * ch_size.x;
    ch_stc.y = floor(float(ch / 4) / 3.0) * ch_size.y;

    // There is a bilinear upsampling operation in the original network
    // to perform pooling. We do the same here relying on hardware sampling.
    const float pooling_factor = 0.5;

    ch_stc += local_stc * pooling_factor;

    return texture(iChannel0, (ch_stc - 1.25 + pooling_factor * vec2(x-1, 1-y)) / iChannelResolution[0].xy);
}

void mainImage( out vec4 fragColor, in vec2 fragCoord )
{
    vec4 c;
    vec4 val = vec4(0.0);
    vec2 stc = floor(fragCoord.xy);

    // Non-linear mapping between 24 input and 12 output channels with 2x2 kernel.

    float index = 4.0 * floor(3.0 * stc.x / iChannelResolution[0].x);

    #define C(ch, y, x) c = fetch(stc, ch, y, x);
    #define F0(idx, f0, f1, f2, f3) val = index == float(idx) ? vec4(f0, f1, f2, f3) * c.x + val : val;
    #define F1(idx, f0, f1, f2, f3) val = index == float(idx) ? vec4(f0, f1, f2, f3) * c.y + val : val;
    #define F2(idx, f0, f1, f2, f3) val = index == float(idx) ? vec4(f0, f1, f2, f3) * c.z + val : val;
    #define F3(idx, f0, f1, f2, f3) val = index == float(idx) ? vec4(f0, f1, f2, f3) * c.w + val : val;

    C(0, 0, 0)
    F0(0,-0.235,-0.5725,-0.1175,-1.55)F0(4,0.018,-0.0083875,0.55,-0.99375)F0(8,0.2,-0.215,-0.34625,-0.33375)
    F1(0,0.006825,-0.5025,0.1625,3.4)F1(4,0.028625,-0.005425,-0.63375,0.20125)F1(8,0.38625,-0.515,-0.55375,-0.41125)
    F2(0,-1.4375,1.65,-1.1625,0.17375)F2(4,-0.44,0.23,-0.2625,1.3625)F2(8,0.76625,-0.58625,0.16125,-1.1375)
    F3(0,-0.0735,-0.2725,-0.0615,0.95375)F3(4,0.02875,-0.0092875,0.19875,-0.37625)F3(8,-0.48125,-0.09625,0.34375,0.355)
    C(4, 0, 0)
    F0(0,0.23125,-1.725,-0.08275,-1.475)F0(4,-0.035125,0.01875,-0.041125,0.68125)F0(8,-0.23375,0.77125,-0.062125,-0.089875)
    F1(0,0.3025,-0.16125,0.235,0.5575)F1(4,-0.069625,-0.0082375,-1.25,0.64125)F1(8,0.14,0.195,-0.34875,-0.31125)
    F2(0,-0.30625,-0.5225,-0.6275,0.5275)F2(4,0.039,-0.0135,-0.76875,0.1125)F2(8,0.41,0.6775,0.69375,0.5725)
    F3(0,0.3175,0.45875,0.088875,0.19375)F3(4,-0.01525,-0.013625,0.15875,-0.58625)F3(8,0.84875,-0.35375,0.615,0.1075)
    C(8, 0, 0)
    F0(0,-0.15875,-0.089375,-0.095,-2.0125)F0(4,-0.061375,0.071,-0.76625,-0.8025)F0(8,0.69625,0.41,-0.2025,-0.34125)
    F1(0,0.2075,-0.49125,-0.083375,-1.6)F1(4,0.07925,-0.0235,-0.385,0.082)F1(8,-0.10375,0.54375,0.1175,-0.13375)
    F2(0,1.325,0.33875,1.3,-0.59375)F2(4,0.079625,-0.042125,0.64875,0.54)F2(8,0.5325,0.545,-0.5225,-0.43625)
    F3(0,0.2875,0.60125,0.048,-0.945)F3(4,0.01525,-0.03825,-0.63375,1.325)F3(8,-0.45375,0.33625,0.18375,0.19125)
    C(12, 0, 0)
    F0(0,-0.20625,0.52125,-0.18625,0.1675)F0(4,-0.029375,0.03625,-0.2625,-1.0375)F0(8,-0.8675,-0.8275,0.1025,-0.01625)
    F1(0,0.2425,0.2,0.10375,-0.8525)F1(4,0.0001075,-0.022625,-0.050625,0.5)F1(8,-0.04575,0.40875,-0.19625,-0.19125)
    F2(0,0.057375,0.2025,-0.025625,-0.875)F2(4,-0.00034125,-0.03575,0.16,-0.82625)F2(8,-0.83375,-0.62125,0.2475,0.04925)
    F3(0,-0.58,-0.235,-0.5025,-1.55)F3(4,0.031625,-0.009075,-0.1575,-1.2125)F3(8,-0.87875,-0.145,-0.35,-0.37)
    C(16, 0, 0)
    F0(0,-0.18375,0.10375,-0.030875,-1.05)F0(4,-0.05225,0.0575,0.2675,0.03575)F0(8,0.6025,0.0795,0.1,0.11125)
    F1(0,0.1475,-1.0375,-0.31375,-0.50625)F1(4,-0.265,0.25125,1.1125,0.455)F1(8,-0.094125,0.10875,0.07925,0.09125)
    F2(0,-0.19125,-1.1,-0.077625,-1.4)F2(4,0.03,-0.013875,-0.53125,0.48875)F2(8,0.56375,0.58,-0.10375,0.0115)
    F3(0,0.31375,0.10375,0.08575,-0.009325)F3(4,-0.029625,-0.022875,0.0013875,-0.080375)F3(8,0.31625,-0.245,-0.28625,-0.13)
    C(20, 0, 0)
    F0(0,0.53875,1.525,0.59625,-0.41875)F0(4,0.17375,-0.25125,-2.625,0.30375)F0(8,1.45,-0.5475,0.047625,0.12625)
    F1(0,0.0038,0.59125,0.25375,0.29625)F1(4,-0.021375,0.017,-0.3125,-0.06425)F1(8,0.058875,0.1225,-0.086875,-0.07975)
    F2(0,-0.021625,-0.15,-0.1125,1.325)F2(4,0.085,-0.0605,-0.079625,0.2)F2(8,-1.275,-0.26,-0.0215,0.12625)
    F3(0,-0.4025,-0.74875,-0.40625,0.96875)F3(4,-0.05825,0.049375,-0.595,-0.33875)F3(8,-0.22375,-1.1,0.31375,0.4525)
    C(0, 1, 0)
    F0(0,-0.22375,0.96125,-0.13625,0.2125)F0(4,-0.098625,0.04775,-0.7075,1.0625)F0(8,-0.1625,0.305,0.13625,0.34)
    F1(0,0.8725,0.1675,0.7075,-1.4)F1(4,-0.016375,0.008925,0.31125,-0.16375)F1(8,-0.66875,0.49375,-0.20375,-0.22875)
    F2(0,1.8625,-1.4375,0.755,0.72375)F2(4,0.34125,-0.19125,0.8625,0.4125)F2(8,-0.4025,-0.45125,-0.13875,0.31875)
    F3(0,0.29375,0.77375,0.30625,-1.5875)F3(4,0.028875,-0.020875,0.2625,0.69875)F3(8,0.7125,0.46375,-0.23875,-0.2825)
    C(4, 1, 0)
    F0(0,0.4175,2.075,0.58,1.6375)F0(4,-0.1,0.047375,0.3775,0.685)F0(8,-0.26625,-0.60125,0.1675,0.7975)
    F1(0,-0.0305,-0.86125,0.028,-0.8375)F1(4,0.078,-0.011625,-0.5475,0.053375)F1(8,0.13,-0.3425,-0.2925,-0.32)
    F2(0,0.10125,-0.56125,-0.063875,-0.555)F2(4,-0.035625,0.00048125,0.84,0.13625)F2(8,-0.81875,-0.785,-0.20625,-0.12)
    F3(0,0.1075,-0.6975,0.36375,-1.575)F3(4,0.049375,-0.0078875,0.3,0.235)F3(8,-0.60375,0.41,-0.465,-0.2525)
    C(8, 1, 0)
    F0(0,0.36625,0.08,0.4975,1.0)F0(4,0.094625,-0.06775,0.6075,-0.09575)F0(8,0.545,0.2675,-0.18,0.049375)
    F1(0,0.37625,0.76875,0.535,0.01075)F1(4,-0.08375,0.0072125,1.3875,0.67)F1(8,0.82,0.33625,-0.40625,-0.23125)
    F2(0,0.31375,0.1825,0.36625,0.26125)F2(4,-0.076375,0.073375,0.0205,-0.445)F2(8,-0.2525,0.11625,-0.09725,-0.12125)
    F3(0,-0.17125,-0.97375,-0.087875,0.125)F3(4,0.0675,-0.039875,0.59,-1.3625)F3(8,0.59125,-0.8025,0.3075,0.0745)
    C(12, 1, 0)
    F0(0,-0.065625,-0.8825,-0.018125,0.92875)F0(4,0.014125,-0.00705,-0.4675,0.2825)F0(8,0.12875,0.34125,0.01775,0.28875)
    F1(0,0.51375,-0.28375,0.5625,0.24875)F1(4,-0.03175,0.077125,-0.10375,-0.32125)F1(8,-0.3575,0.145,-0.33,-0.17875)
    F2(0,-0.2125,-0.755,-0.14625,1.025)F2(4,0.010625,0.0245,-0.34125,0.44625)F2(8,0.265,-0.38875,0.145,0.17125)
    F3(0,0.089625,0.4925,0.050125,0.42375)F3(4,-0.0055625,0.000565,0.56375,0.43875)F3(8,0.265,0.435,0.195,0.23625)
    C(16, 1, 0)
    F0(0,-0.90375,-0.3025,-0.89375,0.75625)F0(4,-0.016125,-0.0415,-0.9675,-0.5725)F0(8,-1.025,-0.89875,0.30875,0.31)
    F1(0,-0.7925,0.21125,0.67625,-0.15)F1(4,-0.3375,0.29375,-0.84125,-0.525)F1(8,0.1275,0.59125,-0.67625,0.75)
    F2(0,0.71125,0.62125,0.55625,0.44375)F2(4,0.006025,0.0088625,0.28,-0.5675)F2(8,-0.70625,0.04075,-0.2,-0.20375)
    F3(0,0.15,-0.765,0.2525,-1.5875)F3(4,0.05625,0.035375,0.0003975,0.2975)F3(8,0.4625,0.13625,-0.083375,-0.30875)
    C(20, 1, 0)
    F0(0,-0.1875,-1.1375,-1.375,-0.91875)F0(4,0.7375,-0.3725,0.44625,-0.42625)F0(8,-2.15,-0.5275,0.38625,-0.9575)
    F1(0,-0.30875,-0.5175,-0.415,-0.95125)F1(4,-0.0045625,-0.04175,0.5625,0.09475)F1(8,0.32875,-0.21,0.8575,0.85125)
    F2(0,0.18125,0.2825,0.10375,-1.8375)F2(4,-0.1025,0.06925,0.30375,0.215)F2(8,0.44375,-0.0092,0.21875,0.07775)
    F3(0,0.1075,0.9725,0.3875,-0.5725)F3(4,0.076,-0.088625,-0.36375,-0.295)F3(8,0.56125,0.3475,-0.054,-0.085875)
    C(0, 0, 1)
    F0(0,-0.43375,-0.17375,-0.34375,0.9525)F0(4,-0.01975,0.0465,-0.83625,-0.037875)F0(8,0.4325,-0.25875,0.96625,0.83)
    F1(0,-0.11375,0.2875,-0.245,-1.8375)F1(4,0.00735,0.014,0.24875,-0.3075)F1(8,-0.53875,0.3975,-0.23875,-0.14)
    F2(0,0.205,-0.75125,1.25,-0.65625)F2(4,0.63,-0.4625,-0.4,-1.5625)F2(8,-0.75875,-0.17375,-0.47125,1.3)
    F3(0,-0.3675,0.22125,-0.265,-0.9475)F3(4,-0.01625,0.039375,0.064875,-0.29625)F3(8,0.155,-0.15125,0.215,0.2725)
    C(4, 0, 1)
    F0(0,-0.059875,1.3375,1.075,1.7)F0(4,0.080625,-0.00865,-0.0535,-0.53375)F0(8,1.0125,-0.64625,0.24625,0.64375)
    F1(0,-0.50125,-0.86875,-0.3925,-0.89125)F1(4,0.068125,0.01575,0.24,-0.042125)F1(8,0.065125,-0.02375,0.395,0.16625)
    F2(0,0.12,-0.031625,0.41625,-1.4625)F2(4,-0.155,0.097375,0.8225,-0.57)F2(8,0.08975,0.25875,-0.4575,-0.4775)
    F3(0,-0.99000001,-1.1125,-0.93375,-0.375)F3(4,0.02275,0.04675,-0.3525,0.1575)F3(8,-1.3625,-0.63875,-0.24375,0.185)
    C(8, 0, 1)
    F0(0,-0.44875,-0.072125,-0.46375,0.66)F0(4,0.045,-0.0815,0.7575,1.35)F0(8,-1.575,0.10375,0.12125,0.32)
    F1(0,-0.295,0.555,-0.12625,-1.0125)F1(4,-0.097,0.04425,0.81375,0.059625)F1(8,-0.054125,0.0405,1.025,1.05)
    F2(0,0.043625,-0.14875,-0.13125,0.3575)F2(4,-0.078375,0.02775,-0.02,0.245)F2(8,-0.045125,0.022,0.535,0.53125)
    F3(0,0.295,0.11625,0.15625,0.7825)F3(4,-0.0445,-0.0071125,0.5825,0.2775)F3(8,-0.36625,0.18125,-0.7625,-0.805)
    C(12, 0, 1)
    F0(0,-0.32375,-0.6375,-0.31875,0.6)F0(4,-0.002025,-0.01075,-0.8375,0.3975)F0(8,0.61375,-0.26125,-0.60875,-0.3425)
    F1(0,-0.17375,-0.68,-0.18375,0.83)F1(4,0.053375,-0.031125,0.14875,-0.315)F1(8,0.22125,0.031,-0.52375,-0.38625)
    F2(0,0.355,-0.11,0.305,1.925)F2(4,0.011875,0.04825,-0.19375,0.655)F2(8,1.1,0.23,-0.2375,0.01375)
    F3(0,-0.03775,0.086,-0.061,1.2625)F3(4,-0.014125,0.02525,-0.2425,0.33)F3(8,0.0087875,-0.1375,0.2875,0.32875)
    C(16, 0, 1)
    F0(0,0.11125,0.11125,0.0265,-0.32875)F0(4,0.054125,-0.06875,0.010125,0.26375)F0(8,-0.1775,0.345,-0.17125,-0.19)
    F1(0,-0.033875,0.35375,0.01,0.5925)F1(4,0.35,-0.3375,-0.6375,-0.19375)F1(8,0.054,-0.155,-0.2225,-0.24125)
    F2(0,-0.003325,0.94875,-0.1325,0.26625)F2(4,0.015875,-0.029375,1.175,0.10625)F2(8,-0.039875,0.013625,0.25125,0.022)
    F3(0,-0.1025,-0.24,0.41625,-1.6125)F3(4,0.056625,-0.010375,0.1875,0.57125)F3(8,0.0705,0.445,0.815,0.6875)
    C(20, 0, 1)
    F0(0,-0.07525,0.2475,0.16375,-0.78)F0(4,-0.3175,0.25625,1.6,-0.3625)F0(8,-1.175,-0.076125,0.071875,0.18375)
    F1(0,0.31625,-0.21,0.10625,-1.175)F1(4,0.045,-0.073125,1.0625,0.68)F1(8,-0.0017875,0.3525,0.09025,0.00064125)
    F2(0,0.017125,0.1325,0.1225,-3.1875)F2(4,-0.08975,0.05975,0.053375,-0.86375)F2(8,1.775,0.046,-0.10375,-0.21)
    F3(0,-0.04775,1.0,-0.07875,-0.945)F3(4,0.0985,-0.091375,0.0555,0.5725)F3(8,-0.4775,0.20625,-0.66,-0.66375)
    C(0, 1, 1)
    F0(0,-0.225,-0.57,-0.235,-1.2125)F0(4,0.0945,-0.0695,0.7125,-1.125)F0(8,-0.05175,-0.12375,-0.11125,-0.1)
    F1(0,-0.1325,-0.2125,0.015,0.52625)F1(4,-0.027,-0.01725,-0.2375,0.265)F1(8,0.55,-0.32625,0.09425,0.00029625)
    F2(0,-1.0625,1.025,-1.3,0.48625)F2(4,-0.455,0.3175,0.14625,0.060875)F2(8,0.7575,0.22375,0.14875,-0.5275)
    F3(0,-0.33375,-0.225,-0.28875,0.053625)F3(4,-0.047375,-0.017625,-0.155,0.096875)F3(8,-0.18,-0.255,1.2625,1.175)
    C(4, 1, 1)
    F0(0,-0.34375,-1.775,-1.3625,-1.2625)F0(4,0.012375,-0.078875,-0.54125,-1.05)F0(8,-0.51,0.87875,0.5375,-0.57375)
    F1(0,-0.22375,0.3875,-0.38125,0.51)F1(4,-0.0535,-0.01475,-0.25375,0.315)F1(8,0.47,0.025,0.2525,0.45)
    F2(0,0.10625,0.62125,0.15125,1.2375)F2(4,0.14875,-0.097,-0.86,0.56)F2(8,0.2275,-0.2275,0.040625,0.035125)
    F3(0,-0.058875,0.40375,-0.067375,1.175)F3(4,-0.0090125,-0.05125,-0.325,-0.032)F3(8,0.69125,-0.15375,0.23875,-0.07275)
    C(8, 1, 1)
    F0(0,0.5125,-0.064375,0.525,-0.6675)F0(4,-0.083125,0.07575,-0.1625,-0.75625)F0(8,0.46875,-0.61375,0.265,-0.20625)
    F1(0,-0.20125,-0.485,-0.265,1.1)F1(4,0.105,-0.033,-0.90875,-0.07825)F1(8,0.11875,-0.18875,0.60625,0.5475)
    F2(0,-0.074375,-0.27375,-0.096,-0.045625)F2(4,0.0865,-0.065875,-0.16375,-0.024)F2(8,-0.0465,-0.079875,0.0605,0.081625)
    F3(0,0.46875,0.23625,0.275,1.125)F3(4,-0.025375,0.0585,-0.59375,0.49625)F3(8,-0.42375,0.2025,-0.3,-0.052375)
    C(12, 1, 1)
    F0(0,0.44875,0.495,0.44,-0.17875)F0(4,0.018,-0.01025,0.805,-0.76875)F0(8,-0.71125,-0.24875,0.056875,-0.3875)
    F1(0,0.925,0.9525,0.78375,0.64625)F1(4,-0.04975,-0.0091625,0.19125,0.8175)F1(8,0.1175,0.24625,0.14,0.002525)
    F2(0,-0.26125,0.011375,-0.26,-0.77875)F2(4,-0.02525,-0.02875,-0.7525,-0.905)F2(8,-1.2,-0.059875,-0.18375,-0.36875)
    F3(0,0.1175,0.38625,0.2525,-1.3)F3(4,-0.0057875,-0.001225,0.44875,-0.58625)F3(8,-0.715,-0.43625,-0.04025,-0.15625)
    C(16, 1, 1)
    F0(0,0.32375,-0.2075,0.42,0.25625)F0(4,0.0027875,0.08025,0.1,-0.2575)F0(8,0.38625,0.34375,-0.8675,-0.8675)
    F1(0,0.58625,0.3825,-0.33625,0.03525)F1(4,1.525,-1.3625,0.3,0.18125)F1(8,-0.46,-0.47125,0.84875,-0.41125)
    F2(0,0.53375,0.04975,0.49875,0.55125)F2(4,-0.04575,0.034625,-0.38125,0.5)F2(8,0.59,-0.515,-0.02625,0.16875)
    F3(0,-0.3525,0.20625,-0.6725,-0.7125)F3(4,-0.06775,-0.006525,-0.885,0.060625)F3(8,0.1,0.165,-0.36625,-0.22)
    C(20, 1, 1)
    F0(0,0.12625,-1.125,1.0,1.1625)F0(4,-2.0375,1.75,0.1625,-0.16375)F0(8,1.95,0.6775,-1.1875,-0.0012625)
    F1(0,-0.33625,-0.445,-0.055875,1.5)F1(4,-0.02275,0.1,-1.5375,-0.88625)F1(8,-1.3375,-0.5775,-0.90875,-0.63375)
    F2(0,0.1,0.32875,-0.004975,1.6125)F2(4,0.094125,-0.061125,0.003125,0.17875)F2(8,-1.125,0.4325,-0.013625,0.1625)
    F3(0,0.0385,-0.90875,-0.12375,-0.06875)F3(4,-0.11625,0.12625,0.62875,-0.21375)F3(8,0.2175,-0.0605,0.44625,0.43125)

    // Biases

    #define F(idx, f0, f1, f2, f3) val = index == float(idx) ? vec4(f0, f1, f2, f3) + val : val;

    F(0,1.12352669,2.3,0.34690702,1.28966069)
    F(4,-2.88188791,2.60484695,0.46568558,0.25229403)
    F(8,3.60696173,1.03364789,0.09012905,-0.56845796)

    // ReLU
    val = max(vec4(0.0), val);

    fragColor = vec4(val);
}

#include <../common/main_shadertoy.frag>