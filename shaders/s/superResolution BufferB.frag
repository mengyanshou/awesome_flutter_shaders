
// superResolution - Buf B
//
// Conv 1 - 6x6x24
//
// Image Super-Resolution Using Deep Convolutional Networks.
// Shadertoy implementation of SRCNN described in https://arxiv.org/pdf/1501.00092.pdf
//
// Created by Dmitry Andreev - and'2017
// License Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License.

float fetch(const vec2 stc, const int y, const int x)
{
    vec2 local_size = floor(iResolution.xy / vec2(3, 2));
    vec2 local_stc = stc - local_size * floor(stc / local_size);

    return texture(iChannel0, (local_stc + 0.5 + vec2(float(x) - 2.0, 3.0 - float(y))) / iChannelResolution[0].xy).a;
}

void mainImage(out vec4 fragColor, in vec2 fragCoord)
{
    float c;
    vec4  val = vec4(0.0);
    vec2  stc = floor(fragCoord.xy);

    // Patch extraction and representation with 24 6x6 filters over a single luminance channel.

    float index = 4.0 * (floor(3.0 * stc.x / iChannelResolution[0].x) + 3.0 * floor(2.0 * stc.y / iChannelResolution[0].y));

    #define C(y, x) c = fetch(stc, y, x);
    #define F(idx, f0, f1, f2, f3) val = index == float(idx) ? vec4(f0, f1, f2, f3) * c + val : val;

    C(0, 0)
    F(0,0.239,0.6935,3.865,-0.08295)F(4,-0.104,0.371,0.09275,-0.0707)F(8,0.289,-0.661,0.113,0.102)
    F(12,-0.6675,-0.7145,0.388,-0.03925)F(16,-0.359,-0.0602,-0.5745,0.1175)F(20,0.02165,0.9385,1.005,-0.3435)
    C(1, 0)
    F(0,0.262,-1.935,-8.85,-0.262)F(4,0.04395,-0.3665,-0.298,-0.2215)F(8,0.872,0.16,0.108,-1.325)
    F(12,-0.628,2.765,-0.005395,-0.47)F(16,-0.195,0.2615,0.785,-0.458)F(20,-0.159,-1.0,0.2795,0.5205)
    C(2, 0)
    F(0,-3.155,-0.185,4.075,0.03605)F(4,-0.276,0.7825,-0.2795,0.658)F(8,0.953,0.462,0.568,3.38)
    F(12,2.545,-8.195,-1.575,1.25)F(16,-0.09255,-0.6235,-1.89,0.9155)F(20,0.549,-2.265,0.2305,-0.04635)
    C(3, 0)
    F(0,1.345,1.9,4.57,0.0564)F(4,0.854,-0.9375,0.2915,1.51)F(8,-1.765,0.371,-1.61,-2.085)
    F(12,-0.532,3.54,2.08,-1.595)F(16,-0.221,0.2585,2.055,-0.1125)F(20,-0.2065,0.9395,0.245,-0.705)
    C(4, 0)
    F(0,-0.964,-0.008765,-8.36,-0.227)F(4,-0.2355,-0.5955,0.606,0.0465)F(8,0.7455,-0.7235,0.433,0.847)
    F(12,-1.485,-1.435,-1.41,0.5555)F(16,0.3155,-0.117,-0.413,-0.5285)F(20,0.11,0.3645,-1.405,-0.11)
    C(5, 0)
    F(0,0.03025,-0.38,3.475,0.07)F(4,-0.03765,0.819,-0.4605,-0.545)F(8,0.1255,0.248,0.05895,-0.007515)
    F(12,0.6685,0.0143,0.54,0.253)F(16,-0.405,0.02415,-0.1055,-0.327)F(20,-0.02675,-0.0298,0.468,0.0358)
    C(0, 1)
    F(0,0.2405,-0.471,-4.625,0.2795)F(4,0.0234,-0.656,-0.1105,-0.525)F(8,-0.6885,0.07,-0.4355,-0.5785)
    F(12,0.137,0.2845,-0.3965,0.131)F(16,0.5485,0.11,0.705,0.679)F(20,-0.11,-1.825,-0.9835,0.4565)
    C(1, 1)
    F(0,-0.8235,3.02,8.56,0.0836)F(4,-0.3445,-1.515,0.6355,2.255)F(8,-3.16,1.055,0.0337,2.015)
    F(12,2.285,-1.39,-0.966,-1.56)F(16,0.87,-0.3225,-1.115,1.915)F(20,0.275,1.72,-5.93,-0.7415)
    C(2, 1)
    F(0,7.545,0.9865,-3.55,0.6855)F(4,0.2485,1.52,0.7065,-3.515)F(8,0.6695,-1.2,-0.4185,-6.645)
    F(12,-6.96,10.45,5.735,-1.52)F(16,-2.665,1.595,5.555,-7.255)F(20,-1.47,5.005,4.615,-0.218)
    C(3, 1)
    F(0,-3.325,-3.31,-7.2,-0.3395)F(4,-0.2835,3.235,-1.86,-5.355)F(8,2.85,-0.43,4.095,3.905)
    F(12,1.235,-1.57,-3.36,6.365)F(16,1.475,-0.246,-4.53,3.08)F(20,0.27,-0.518,1.005,1.985)
    C(4, 1)
    F(0,1.72,-0.4375,9.425,0.1455)F(4,0.6455,0.08655,0.217,0.306)F(8,-0.4915,0.594,-0.7445,-0.963)
    F(12,3.345,-0.644,0.378,-0.89)F(16,-0.8755,0.1695,0.189,1.165)F(20,-0.186,-0.67,0.8165,-0.4215)
    C(5, 1)
    F(0,-0.02685,-0.04485,-4.235,0.00362)F(4,-0.2815,-0.8945,0.4365,0.3325)F(8,0.563,-0.634,-0.0908,0.01485)
    F(12,-1.455,0.598,0.00776,-0.537)F(16,0.664,0.05345,0.115,0.34)F(20,-0.0151,-0.14,0.4065,0.1035)
    C(0, 2)
    F(0,-1.58,-0.247,7.13,-0.119)F(4,-0.1985,2.42,-0.613,1.525)F(8,-1.255,-0.621,0.8835,2.625)
    F(12,-0.224,0.1205,-3.155,3.725)F(16,-0.8575,-0.715,-0.986,-1.925)F(20,0.6135,1.545,-1.725,0.5515)
    C(1, 2)
    F(0,3.815,-3.32,-12.55,0.6715)F(4,1.76,-2.45,0.1605,-6.24)F(8,4.09,-0.1385,-0.92,-7.645)
    F(12,0.3715,1.13,7.215,-5.46)F(16,-2.07,3.28,2.2,5.83)F(20,-2.765,-0.7365,7.525,0.3965)
    C(2, 2)
    F(0,-14.4,-4.805,5.005,-2.605)F(4,-15.75,-1.16,-1.33,6.65)F(8,9.54,0.1945,1.03,16.55)
    F(12,7.14,-5.915,-7.965,6.155)F(16,-3.21,-8.015,-19.6,3.005)F(20,6.855,-11.2,8.13,2.165)
    C(3, 2)
    F(0,6.69,8.66,8.555,-0.0325)F(4,5.155,-1.54,3.225,7.085)F(8,-9.985,1.495,-21.65,-9.065)
    F(12,-3.61,2.05,7.34,-3.915)F(16,-2.8,1.16,20.55,-7.85)F(20,-0.988,2.525,-9.73,-4.6)
    C(4, 2)
    F(0,-3.625,-1.075,-12.15,-0.0408)F(4,-1.585,-0.751,0.397,-1.165)F(8,2.975,-0.9275,4.58,3.26)
    F(12,-2.405,0.607,-4.445,-3.825)F(16,1.075,-0.2405,-4.325,1.95)F(20,0.224,1.435,0.9775,1.56)
    C(5, 2)
    F(0,1.35,1.315,5.83,0.5355)F(4,0.539,1.05,-0.2405,-1.19)F(8,-2.305,1.315,-1.235,-1.33)
    F(12,1.84,0.289,2.085,1.69)F(16,-0.6,0.04795,0.796,-0.177)F(20,-0.04,-0.487,-2.025,-0.789)
    C(0, 3)
    F(0,-1.87,-0.171,-5.755,0.4545)F(4,0.576,-0.5035,1.335,0.9975)F(8,-1.935,1.405,-0.937,0.707)
    F(12,-2.345,0.3195,3.26,-0.783)F(16,0.7675,1.265,0.171,-1.575)F(20,-1.075,-0.619,-1.655,-1.385)
    C(1, 3)
    F(0,8.265,2.24,9.775,-3.055)F(4,-0.6945,2.08,-2.92,-2.415)F(8,7.545,-3.31,0.4725,-3.58)
    F(12,3.015,-1.5,-7.945,-1.86)F(16,-5.44,-8.34,0.554,-4.97)F(20,7.08,3.11,9.505,2.505)
    C(2, 3)
    F(0,-8.78,15.85,-4.15,17.3)F(4,5.04,-0.7095,6.05,1.83)F(8,-13.95,20.35,0.351,7.485)
    F(12,3.055,0.2615,9.27,2.71)F(16,26.6,26.3,-0.2835,7.82)F(20,-22.9,-6.275,-16.7,-7.695)
    C(3, 3)
    F(0,-3.195,-19.5,-8.555,-0.505)F(4,-2.455,3.33,-17.85,1.015)F(8,2.34,-20.6,19.15,1.635)
    F(12,-0.1185,-2.285,-7.865,-6.135)F(16,-4.435,-5.0,-0.665,0.4325)F(20,4.265,2.57,-0.5885,20.45)
    C(4, 3)
    F(0,3.04,3.25,10.8,-0.001425)F(4,1.075,-4.715,12.85,-0.6035)F(8,0.3195,2.31,-3.82,-0.545)
    F(12,-5.52,-0.2415,6.02,6.1)F(16,-0.336,0.534,1.19,-3.51)F(20,-0.365,-1.855,2.31,-11.8)
    C(5, 3)
    F(0,0.794,-1.025,-5.415,-0.594)F(4,-0.2285,0.7605,-3.075,0.7775)F(8,1.565,-1.415,1.085,-0.787)
    F(12,0.8025,0.1235,-2.57,-1.53)F(16,0.8345,-0.105,-1.39,0.6615)F(20,-0.009535,0.1675,0.9985,2.035)
    C(0, 4)
    F(0,2.095,0.208,7.12,-0.794)F(4,-0.5795,-1.665,-0.3505,0.319)F(8,2.815,-0.8495,0.736,-1.285)
    F(12,1.205,-0.473,0.137,-3.165)F(16,0.1805,-0.139,0.308,1.46)F(20,0.1565,-1.34,2.845,0.04155)
    C(1, 4)
    F(0,-6.365,-0.933,-13.65,4.875)F(4,0.1285,2.05,0.938,0.239)F(8,-3.55,-0.5455,-0.0577,3.53)
    F(12,-1.545,0.6925,2.345,5.085)F(16,-1.645,0.3635,-0.7385,0.717)F(20,-0.335,-0.673,-6.47,0.3175)
    C(2, 4)
    F(0,8.68,2.63,6.965,-19.75)F(4,-1.78,-4.005,-1.54,-0.3185)F(8,3.495,-2.65,-0.7335,-8.56)
    F(12,-2.11,0.9405,-7.25,-2.88)F(16,-6.38,-2.11,0.4255,-4.38)F(20,1.98,3.415,3.26,1.815)
    C(3, 4)
    F(0,5.83,-3.94,8.43,-0.009515)F(4,1.01,2.25,5.735,0.4605)F(8,2.355,4.6,-2.185,-3.51)
    F(12,-0.353,0.841,2.78,3.995)F(16,-1.58,-0.385,0.7785,1.975)F(20,0.3265,-0.3185,5.48,-7.835)
    C(4, 4)
    F(0,-3.9,0.9575,-13.45,0.5855)F(4,-0.6155,4.83,-2.63,-0.8115)F(8,-1.85,-0.8275,0.3475,1.805)
    F(12,3.165,-0.2255,-0.762,1.69)F(16,0.916,-0.01235,-0.7325,1.12)F(20,0.04355,-0.6765,-2.545,2.555)
    C(5, 4)
    F(0,0.285,-0.7535,6.74,0.1685)F(4,0.2125,-2.39,1.39,0.4085)F(8,0.7685,0.8125,-0.08405,0.0475)
    F(12,0.2435,-0.367,0.2745,-2.63)F(16,-0.9345,-0.03255,0.99550003,-0.4855)F(20,0.0519,0.52,0.2655,-1.185)
    C(0, 5)
    F(0,0.01705,0.1045,-3.935,0.1625)F(4,-0.123,-0.362,0.2,-0.06115)F(8,-0.5875,-0.2015,-0.219,-0.1025)
    F(12,-0.8,0.709,0.2925,0.2515)F(16,-0.331,0.104,-0.04465,-0.649)F(20,-0.0979,0.5265,-1.07,0.03)
    C(1, 5)
    F(0,0.5535,-0.4855,7.215,-1.995)F(4,0.6565,1.345,-0.316,-0.1885)F(8,0.813,0.93,0.2315,0.03305)
    F(12,1.03,-1.26,-1.395,1.315)F(16,0.385,-0.8335,-0.3925,-0.334)F(20,0.688,-0.119,2.11,-0.1155)
    C(2, 5)
    F(0,-0.3975,0.0952,-4.205,4.595)F(4,0.2985,0.835,0.2395,-0.4455)F(8,-2.635,0.348,-0.442,0.3895)
    F(12,0.175,0.985,2.105,-1.095)F(16,0.7625,1.975,0.8125,2.34)F(20,-1.65,0.5,-1.665,-0.1195)
    C(3, 5)
    F(0,-2.605,1.31,-5.29,0.0116)F(4,0.2445,-3.4,-2.33,0.1485)F(8,-0.8135,-0.871,1.705,1.775)
    F(12,0.0264,-1.425,-1.6,-2.195)F(16,0.8245,-0.837,-1.31,-1.405)F(20,0.708,-0.47,-2.26,2.86)
    C(4, 5)
    F(0,1.04,-0.04305,7.3,-0.2925)F(4,0.0354,0.2075,0.547,0.05775)F(8,0.8905,0.0461,-0.791,-0.4595)
    F(12,-1.58,0.932,0.8315,-0.1515)F(16,-0.8625,0.4245,1.185,0.205)F(20,-0.3855,1.135,1.38,-0.724)
    C(5, 5)
    F(0,0.165,-0.3915,-3.675,-0.2545)F(4,-0.1605,0.5515,0.03535,-0.188)F(8,-0.383,-0.2325,0.1345,-0.3085)
    F(12,0.02065,-0.125,-0.257,0.9465)F(16,0.353,-0.07955,-0.5315,0.05955)F(20,0.05765,-0.528,-0.0805,0.147)

    // Biases

    c = 1.0;
    F(0,-0.09481341,-0.09043419,-1.1155417,0.11924907)
    F(4,0.66757464,-0.03277064,0.48133063,-0.18172741)
    F(8,0.02,0.08191,0.099364,-0.00337064)
    F(12,-0.03180428,-0.00662322,-0.04247172,-0.05498895)
    F(16,-0.22072962,-0.82982278,0.04772876,-0.2557807)
    F(20,0.72482061,4.48396969,-0.19349065,-0.20253918)

    // ReLU
    val = max(vec4(0.0), val);

    fragColor = val;
}
#include <../common/main_shadertoy.frag>
